flowchart LR
  %% --- WEEK 0 (Design) — restored and updated per your text
  subgraph W0["Week 0 — Design"]
    direction TB
    W0_story["Story: PO drafts a contract and product/port idea; 
steward finalizes the contract with types, rules, thresholds and acceptance tests. 
The steward links the contract to product ports and may add or refine input ports. 
Product version is bumped and status is not final until steward/PO sign-off."]:::story
    W0_S1["1. PO drafts the product and contract concept (version created, status: draft)
    <small>product-catalog.png</small>"]
    W0_S2["2. PO defines output ports and initial expectations; 
notes which upstream ports feed this product
    <small>data-product-editor.png</small>"]
    W0_S3["3. PO initiates contract draft; 
Steward completes low-level details (physical types, rules, thresholds, acceptance tests)
    <small>contract-editor.png</small>"]
    W0_S4["4. Steward links the finalized contract to output ports in the Data Product Editor; 
product version increments; 
platform policy requires lifecycle/write-verdict metadata and compatibility expectations
    <small>data-product-editor.png, product-catalog.png</small>"]
    W0_PO["PO — Ana (initiates product & contract)"]:::product-owner
    W0_DS["DS — Steward (finalizes contract & links ports)"]:::data-steward
    W0_PO --> W0_S1
    W0_S1 --> W0_S2 --> W0_S3 --> W0_S4
    W0_DS --> W0_S3
  end

  %% --- WEEK 1 (Implementation) — restored and updated per your text
  subgraph W1["Week 1 — Implementation"]
    direction TB
    W1_story["Story: DE consumes the steward-defined contract: 
binds reads to input ports using dc43 integrations, 
implements transformation rules provided by the steward, 
and uses write_with_governance to enforce contract semantics. 
Platform ensures DC43 services are linked and CI publishes governance metadata to catalog."]:::story
    W1_S1["1. DE configures project to use the deployed dc43 governance service and 
binds reads to the declared input ports (using dc43 integration lib)
    <small>integration-helper-read-code.png</small>"]
    W1_S2["2. DE implements transformation rules (as documented by Steward) 
and uses write_with_governance to write to the output port; 
runtime reports status and verdicts to governance
    <small>integration-helper-write-code.png, databricks-write.png</small>"]
    W1_S3["3. DE publishes read/write examples and documents 
how transformation and compatibility are handled (strict/lenient/audit semantics)
    <small>integration-helper-read-code.png</small>"]
    W1_S4["4. DE configures CI to validate contract presence, required metadata, 
publish metadata to governance storage (catalog), and run basic enforcement tests
    <small>runtime-verdicts.png</small>"]
    W1_DE["DE — Luca (implements adapters & CI)"]:::data-engineer
    W1_PL["Platform (links project to dc43 services & validates policy)"]:::platform
    W1_DE --> W1_S1
    W1_S1 --> W1_S2 --> W1_S3 --> W1_S4
    W1_PL --> W1_S4
  end

  %% --- WEEK 2 (Runtime & Evidence) — clarified
  subgraph W2["Week 2 — Runtime & Evidence"]
    direction TB
    W2_story["Story: The team reviews first runtime outputs: 
datasets produced according to contract, 
metrics and status evidence in the governance UI; 
ops receives findings for further investigation."]:::story
    W2_S1["1. Runtime: reads & writes call Governance service; observations collected
    <small>runtime-verdicts.png</small>"]
    W2_S2["2. Governance emits verdicts and per-port metrics (ok|warn|block)
    <small>runtime-verdicts.png</small>"]
    W2_S3["3. Observability & catalog surfaces metrics and dataset versions for review
    <small>steward-metrics-history.png</small>"]
    W2_S4["4. Team (Steward + PO) reviews early results and notes issues before wider prod ramp
    <small>steward-metrics-history.png</small>"]
    W2_DE["DE — Luca (observes pipeline verdicts)"]:::data-engineer
    W2_DS["DS — Steward (reviews evidence)"]:::data-steward
    W2_S1 --> W2_S2 --> W2_S3 --> W2_S4
    W2_DE --> W2_S1
    W2_DS --> W2_S4
  end

  %% --- WEEK 3 (Steward challenge & Versioning) — clarified
  subgraph W3["Week 3 — Steward challenge & Versioning"]
    direction TB
    W3_story["Story: Steward discovers false positives post-delivery, 
reviews history and decides rule behavior (e.g. make it lenient). 
Steward can act without immediate DE involvement, 
but may request DE investigation to explain discrepancies and 
coordinate upstream changes."]:::story
    W3_S1["1. Steward opens a challenge on a rule due to false positives
    <small>steward-metrics-history.png</small>"]
    W3_S2["2. Steward reproduces the issue using audit outputs and 
historical metrics (no immediate DE needed)
    <small>audit-report.png</small>"]
    W3_S3["3. Steward changes the rule (e.g. to lenient/non-blocking) and 
publishes a new contract version with rationale & tests
    <small>contract-editor.png</small>"]
    W3_S4["4. Steward asks DE to investigate discrepancies and 
to implement any necessary instrumentation or corrective measures upstream; 
PO updates catalog compatibility info
    <small>compatibility-matrix.png, product-catalog.png</small>"]
    W3_S5["5. Platform applies the new version & enforcement across environments
    <small>runtime-verdicts.png</small>"]
    W3_DS["DS — Steward (challenges & publishes new version)"]:::data-steward
    W3_PO["PO — Ana (updates catalog)"]:::product-owner
    W3_DS --> W3_S1 --> W3_S2 --> W3_S3 --> W3_S4 --> W3_S5
    W3_PO --> W3_S4
  end

  %% --- WEEK 4 (Downstream consumption & Shrinkage)
  subgraph W4["Week 4 — Downstream & Shrinkage"]
    direction TB
    W4_story["Story: Analysts see a shrinking valid set; 
the banner and alerts trigger a cross-product investigation."]:::story
    W4_S1["1. Data consumer reads leniently for exploration (read_with_governance mode=lenient)
    <small>databricks-write.png</small>"]
    W4_S2["2. UI shows valid_rows_ratio banner & warnings
    <small>steward-metrics-history.png</small>"]
    W4_S3["3. Metric shows valid_rows_ratio dropping (shrinkage)
    <small>steward-metrics-history.png</small>"]
    W4_S4["4. Alerts raised; DE notified to investigate cross-product impact
    <small>pipeline-rca.png</small>"]
    W4_DC["DC — Marta (exploratory reads)"]:::data-consumer
    W4_DE["DE — Luca (receives alert)"]:::data-engineer
    W4_DC --> W4_S1 --> W4_S2 --> W4_S3 --> W4_S4
    W4_DE --> W4_S4
  end

  %% --- WEEK 5 (Forensics & Remediation)
  subgraph W5["Week 5 — Forensics & Remediation"]
    direction TB
    W5_story["Story: Engineer builds an RCA timeline, steward chooses remediation; 
engineer applies dual-path ingestion and updates product definitions."]:::story
    W5_S1["1. DE collects per-port observations across products (verdicts, metrics, compatibility)
    <small>runtime-verdicts.png</small>"]
    W5_S2["2. DE runs strict vs lenient delta / audit to find offending rows
    <small>audit-report.png</small>"]
    W5_S3["3. Cross-product RCA: identify upstream change (e.g., malformed address)
    <small>dependency-graph.png</small>"]
    W5_S4["4. Steward decides: update rule or ask upstream to fix; publish upstream patch
    <small>contract-editor.png</small>"]
    W5_S5["5. DE implements remediation: dual-path ingestion or protective routing; 
update product definitions & versions
    <small>data-product-editor.png, pipeline-rca.png</small>"]
    W5_DE["DE — Luca (RCA & remediation)"]:::data-engineer
    W5_DS["DS — Steward (decides fix/publish)"]:::data-steward
    W5_DE --> W5_S1 --> W5_S2 --> W5_S3
    W5_DS --> W5_S4
    W5_S4 --> W5_S5
  end

  %% --- WEEKS 6+ (Steady state)
  subgraph W6["Weeks 6+ — Steady state"]
    direction TB
    W6_story["Story: System in steady state — 
monitoring, SLA reporting and audits keep products healthy."]:::story
    W6_S1["1. Monitoring & weekly reports show improvements (fewer incidents)
    <small>steward-metrics-history.png</small>"]
    W6_S2["2. Stewards & platform audit the lifecycle and SLAs
    <small>audit-report.png</small>"]
    W6_S3["3. Analysts trust the dataset; audits/reports are routine
    <small>databricks-write.png</small>"]
    W6_PL["Platform (monitoring & policy)"]:::platform
    W6_DS["DS — Steward (ongoing audit)"]:::data-steward
    W6_S1 --> W6_S2 --> W6_S3
    W6_PL --> W6_S1
    W6_DS --> W6_S2
  end


  %% dummy sequential edges to preserve order
  W0 -.-> W1
  W1 -.-> W2
  W2 -.-> W3
  W3 -.-> W4
  W4 -.-> W5
  W5 -.-> W6

  %% styling
  classDef product-owner fill:#0ea5a3,stroke:#0a6b61,color:#fff;
  classDef data-engineer fill:#3b82f6,stroke:#1f5bbf,color:#fff;
  classDef data-steward fill:#f59e0b,stroke:#b46e00,color:#fff;
  classDef data-consumer fill:#ef4444,stroke:#b22222,color:#fff;
  classDef platform fill:#7c3aed,stroke:#52249f,color:#fff;
  classDef story fill:#ffffff,stroke:#e2e8f0,color:#0f172a;

  class W0_PO product-owner;
  class W0_DS data-steward;
  class W1_DE data-engineer;
  class W1_PL platform;
  class W2_DE data-engineer;
  class W2_DS data-steward;
  class W3_DS data-steward;
  class W3_PO product-owner;
  class W4_DC data-consumer;
  class W4_DE data-engineer;
  class W5_DE data-engineer;
  class W5_DS data-steward;
  class W6_PL platform;
  class W6_DS data-steward;
  class W0_story,W1_story,W2_story,W3_story,W4_story,W5_story,W6_story story;
